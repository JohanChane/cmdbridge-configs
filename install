#!/bin/bash

set -e

# 获取 XDG 配置目录
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
TARGET_DIR="$XDG_CONFIG_HOME/cmdbridge"
SOURCE_DIR="$(cd "$(dirname "$0")/configs" && pwd)"

# 检查源目录是否存在
if [ ! -d "$SOURCE_DIR" ]; then
    echo "错误: 找不到 configs 目录"
    exit 1
fi

# 备份现有配置
backup_existing() {
    local counter=1
    local backup_dir
    
    while true; do
        backup_dir="${TARGET_DIR}_${counter}"
        if [ ! -d "$backup_dir" ]; then
            if [ -d "$TARGET_DIR" ]; then
                echo "备份现有配置到: $backup_dir"
                cp -r "$TARGET_DIR" "$backup_dir"
            fi
            break
        fi
        ((counter++))
    done
}

# 创建目标目录
mkdir -p "$(dirname "$TARGET_DIR")"

# 执行备份和安装
if [ -d "$TARGET_DIR" ]; then
    backup_existing
    echo "删除旧配置: $TARGET_DIR"
    rm -rf "$TARGET_DIR"
fi

echo "安装新配置到: $TARGET_DIR"
cp -r "$SOURCE_DIR" "$TARGET_DIR"

echo "安装完成!"